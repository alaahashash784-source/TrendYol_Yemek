@*
    صفحة عرض طلبات المستخدم - تعرض سجل الطلبات السابقة
    Controller: AccountController.cs → Action: Orders()
    الربط: يستقبل IEnumerable<OrderPage> من DB ويعرضها للمستخدم
*@
@model IEnumerable<mvc_full.Models.OrderPage>

@{
    ViewBag.Title = "Siparislerim";
}

<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="fas fa-shopping-bag text-primary me-2"></i>Siparislerim
                    </h2>
                    <p class="text-muted mb-0">Siparislerinizi buradan takip edebilirsiniz</p>
                </div>
                <a href="@Url.Action("Profile", "Account")" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Profile Don
                </a>
            </div>

            @if (Model != null && Model.Any())
            {
                <!-- Orders List -->
                <div class="orders-list">
                    @foreach (var order in Model)
                    {
                        string currentStatus = order.OrderStatus ?? "Onaylandi";
                        int statusLevel = 1; // Default: Onaylandi
                        string statusBadgeClass = "bg-warning";
                        string statusIcon = "fa-clock";
                        
                        if (currentStatus == "Onaylandi") { statusLevel = 1; statusBadgeClass = "bg-info"; statusIcon = "fa-check-circle"; }
                        else if (currentStatus == "Hazirlaniyor") { statusLevel = 2; statusBadgeClass = "bg-warning"; statusIcon = "fa-fire"; }
                        else if (currentStatus == "Yolda") { statusLevel = 3; statusBadgeClass = "bg-primary"; statusIcon = "fa-motorcycle"; }
                        else if (currentStatus == "Teslim Edildi") { statusLevel = 4; statusBadgeClass = "bg-success"; statusIcon = "fa-check-double"; }
                        else if (currentStatus == "Iptal") { statusLevel = 0; statusBadgeClass = "bg-danger"; statusIcon = "fa-times-circle"; }
                        
                        <div class="card border-0 shadow-sm mb-4 order-card">
                            <div class="card-header bg-white py-3">
                                <div class="row align-items-center">
                                    <div class="col-md-3 col-6">
                                        <small class="text-muted d-block">Siparis No</small>
                                        <span class="fw-bold text-primary">#@order.OrderId</span>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <small class="text-muted d-block">Tarih</small>
                                        <span class="fw-bold">@order.OrderDate.ToString("dd MMM yyyy HH:mm")</span>
                                    </div>
                                    <div class="col-md-3 col-6 mt-2 mt-md-0">
                                        <small class="text-muted d-block">Toplam</small>
                                        <span class="fw-bold text-success fs-5">@order.TotalPrice.ToString("F2") TL</span>
                                    </div>
                                    <div class="col-md-3 col-6 text-md-end mt-2 mt-md-0">
                                        <span class="badge @statusBadgeClass px-3 py-2 fs-6">
                                            <i class="fas @statusIcon me-1"></i>@currentStatus
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="icon-box bg-primary bg-opacity-10 rounded p-2 me-3">
                                                <i class="fas fa-map-marker-alt text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Teslimat Adresi</small>
                                                <span>@(string.IsNullOrEmpty(order.DeliveryAddress) ? "Belirtilmemis" : order.DeliveryAddress)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="icon-box bg-success bg-opacity-10 rounded p-2 me-3">
                                                <i class="fas fa-credit-card text-success"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Odeme Yontemi</small>
                                                <span>@(string.IsNullOrEmpty(order.PaymentMethod) ? "Belirtilmemis" : order.PaymentMethod)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @if (currentStatus != "Iptal")
                                {
                                    <!-- Order Timeline - Dynamic based on status -->
                                    <div class="order-timeline pt-3 border-top">
                                        <div class="timeline-container">
                                            <!-- Step 1: Onaylandi -->
                                            <div class="timeline-step @(statusLevel >= 1 ? "completed" : "")">
                                                <div class="timeline-icon-wrapper">
                                                    <div class="timeline-icon @(statusLevel >= 1 ? "bg-success" : "bg-secondary")">
                                                        @if (statusLevel >= 1)
                                                        {
                                                            <i class="fas fa-check"></i>
                                                        }
                                                        else
                                                        {
                                                            <span>1</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="timeline-label">Onaylandi</div>
                                            </div>
                                            
                                            <div class="timeline-line @(statusLevel >= 2 ? "active" : "")"></div>
                                            
                                            <!-- Step 2: Hazirlaniyor -->
                                            <div class="timeline-step @(statusLevel >= 2 ? "completed" : "") @(statusLevel == 2 ? "current" : "")">
                                                <div class="timeline-icon-wrapper">
                                                    <div class="timeline-icon @(statusLevel >= 2 ? "bg-success" : "bg-secondary") @(statusLevel == 2 ? "pulse" : "")">
                                                        @if (statusLevel >= 2)
                                                        {
                                                            <i class="fas @(statusLevel == 2 ? "fa-fire" : "fa-check")"></i>
                                                        }
                                                        else
                                                        {
                                                            <span>2</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="timeline-label">Hazirlaniyor</div>
                                            </div>
                                            
                                            <div class="timeline-line @(statusLevel >= 3 ? "active" : "")"></div>
                                            
                                            <!-- Step 3: Yolda -->
                                            <div class="timeline-step @(statusLevel >= 3 ? "completed" : "") @(statusLevel == 3 ? "current" : "")">
                                                <div class="timeline-icon-wrapper">
                                                    <div class="timeline-icon @(statusLevel >= 3 ? "bg-success" : "bg-secondary") @(statusLevel == 3 ? "pulse" : "")">
                                                        @if (statusLevel >= 3)
                                                        {
                                                            <i class="fas @(statusLevel == 3 ? "fa-motorcycle" : "fa-check")"></i>
                                                        }
                                                        else
                                                        {
                                                            <span>3</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="timeline-label">Yolda</div>
                                            </div>
                                            
                                            <div class="timeline-line @(statusLevel >= 4 ? "active" : "")"></div>
                                            
                                            <!-- Step 4: Teslim Edildi -->
                                            <div class="timeline-step @(statusLevel >= 4 ? "completed" : "")">
                                                <div class="timeline-icon-wrapper">
                                                    <div class="timeline-icon @(statusLevel >= 4 ? "bg-success" : "bg-secondary")">
                                                        @if (statusLevel >= 4)
                                                        {
                                                            <i class="fas fa-check-double"></i>
                                                        }
                                                        else
                                                        {
                                                            <span>4</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="timeline-label">Teslim Edildi</div>
                                            </div>
                                        </div>
                                        
                                        @if (statusLevel == 2)
                                        {
                                            <div class="status-message mt-3 text-center">
                                                <div class="alert alert-warning py-2 mb-0">
                                                    <i class="fas fa-fire me-2"></i>Siparisiz hazirlaniyor... Tahmini sure: 15-20 dakika
                                                </div>
                                            </div>
                                        }
                                        else if (statusLevel == 3)
                                        {
                                            <div class="status-message mt-3 text-center">
                                                <div class="alert alert-info py-2 mb-0">
                                                    <i class="fas fa-motorcycle me-2"></i>Kuryemiz yola cikti! Tahmini varis: 10-15 dakika
                                                </div>
                                            </div>
                                        }
                                        else if (statusLevel == 4)
                                        {
                                            <div class="status-message mt-3 text-center">
                                                <div class="alert alert-success py-2 mb-0">
                                                    <i class="fas fa-check-double me-2"></i>Siparisiz basariyla teslim edildi. Afiyet olsun!
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-danger py-2 mb-0 mt-3">
                                        <i class="fas fa-times-circle me-2"></i>Bu siparis iptal edilmistir.
                                    </div>
                                }
                            </div>
                            <div class="card-footer bg-white border-0 py-3">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <a href="@Url.Action("Index", "Restaurant")" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-redo me-1"></i>Tekrar Siparis Ver
                                    </a>
                                    @if (statusLevel == 4)
                                    {
                                        <button class="btn btn-outline-warning btn-sm" disabled>
                                            <i class="fas fa-star me-1"></i>Degerlendirme Yap
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Empty State -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="empty-icon mb-4">
                            <i class="fas fa-shopping-bag fa-5x text-muted opacity-50"></i>
                        </div>
                        <h4 class="text-muted mb-3">Henuz siparis vermediniz</h4>
                        <p class="text-muted mb-4">Lezzetli yemeklerimizi kesfetmeye ne dersiniz?</p>
                        <a href="@Url.Action("Index", "Restaurant")" class="btn btn-primary btn-lg">
                                <i class="fas fa-utensils me-2"></i>Restoranlari Kesfedin
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 15px;
    }
    
    .order-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    
    /* Timeline Styles */
    .timeline-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 10px;
    }
    
    .timeline-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 0 0 auto;
    }
    
    .timeline-icon-wrapper {
        position: relative;
    }
    
    .timeline-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .timeline-icon.pulse {
        animation: pulse 1.5s infinite;
    }
    
    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .timeline-label {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        font-weight: 500;
        text-align: center;
    }
    
    .timeline-step.completed .timeline-label {
        color: #28a745;
        font-weight: 600;
    }
    
    .timeline-step.current .timeline-label {
        color: #28a745;
        font-weight: 700;
    }
    
    .timeline-line {
        flex: 1;
        height: 4px;
        background: #e0e0e0;
        margin: 0 5px;
        margin-bottom: 25px;
        border-radius: 2px;
        transition: background 0.3s ease;
    }
    
    .timeline-line.active {
        background: linear-gradient(90deg, #28a745, #28a745);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
    }
    
    @@media (max-width: 576px) {
        .timeline-container {
            padding: 15px 5px;
        }
        .timeline-icon {
            width: 35px;
            height: 35px;
            font-size: 12px;
        }
        .timeline-label {
            font-size: 10px;
        }
        .timeline-line {
            margin-bottom: 20px;
        }
    }
</style>
